// ==UserScript==// @name         文言文划词翻译// @namespace    http://tampermonkey.net/// @version      1.3// @description  A script for text translation and query with a popup icon "译" after selection.// @author       Your Name// @match        *://*/*// @grant        GM_xmlhttpRequest// @connect      ark.cn-beijing.volces.com// ==/UserScript==(function () {    'use strict';    // Create popup elements    const popup = document.createElement('div');    popup.style.position = 'absolute';    popup.style.background = '#f9f9f9';    popup.style.border = '1px solid #ccc';    popup.style.padding = '10px';    popup.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';    popup.style.display = 'none';    popup.style.zIndex = '1000';    popup.style.fontSize = '16px'; // 字体大小    popup.style.lineHeight = '1.5'; // 行高，确保字距不重叠    document.body.appendChild(popup);    // Create translate icon    const translateIcon = document.createElement('div');    translateIcon.textContent = '译';    translateIcon.style.position = 'absolute';    translateIcon.style.background = '#007bff';    translateIcon.style.color = '#fff';    translateIcon.style.borderRadius = '50%';    translateIcon.style.width = '30px';    translateIcon.style.height = '30px';    translateIcon.style.display = 'flex';    translateIcon.style.alignItems = 'center';    translateIcon.style.justifyContent = 'center';    translateIcon.style.fontSize = '16px';    translateIcon.style.cursor = 'pointer';    translateIcon.style.display = 'none';    translateIcon.style.zIndex = '1000';    document.body.appendChild(translateIcon);    // API details    const API_URL = 'https://ark.cn-beijing.volces.com/api/v3/chat/completions';    const API_KEY = 'c0a1a617-8293-46ee-a629-ecaf81e3f764';    const MODEL_ID = 'ep-20241231175813-r2hrv';    // Fetch data via GM_xmlhttpRequest    function fetchViaTampermonkey(selectedText) {        return new Promise((resolve, reject) => {            GM_xmlhttpRequest({                method: 'POST',                url: API_URL,                headers: {                    'Content-Type': 'application/json',                    'Authorization': `Bearer ${API_KEY}`,                },                data: JSON.stringify({                    model: MODEL_ID,                    messages: [                        { role: 'system', content: '你是个古代大学士，凡是人们对古文有疑惑之处都能返回满意的答案，如果输入是文言文，则输出其白话文翻译，如果是单个的词，则输出这个词的含义' },                        { role: 'user', content: selectedText },                    ],                }),                onload: function (response) {                    if (response.status === 200) {                        resolve(JSON.parse(response.responseText));                    } else {                        reject(`Request failed with status ${response.status}`);                    }                },                onerror: function (error) {                    reject(error);                },            });        });    }    // Show translate icon near selected textdocument.addEventListener('mouseup', (event) => {    const selectedText = window.getSelection().toString().trim();    if (selectedText) {        // 使用鼠标的位置设置图标位置        translateIcon.style.left = `${event.pageX + 5}px`; // 鼠标位置的X坐标        translateIcon.style.top = `${event.pageY + 5}px`; // 鼠标位置的Y坐标        translateIcon.style.display = 'flex';        translateIcon.dataset.text = selectedText; // 将选中文字存储到图标的数据集    } else {        translateIcon.style.display = 'none';        popup.style.display = 'none';    }});    // Handle click on translate icon    translateIcon.addEventListener('click', async () => {        const selectedText = translateIcon.dataset.text;        if (selectedText) {            popup.textContent = '查询中...';            popup.style.left = `${translateIcon.style.left}`;            popup.style.top = `${parseFloat(translateIcon.style.top) + 40}px`;            popup.style.display = 'block';            try {                const data = await fetchViaTampermonkey(selectedText);                const content = data.choices[0].message.content;                popup.textContent = content;            } catch (error) {                popup.textContent = `请求失败: ${error}`;            }        }    });    // Hide popup and translate icon when clicking elsewhere    document.addEventListener('mousedown', (event) => {        if (            !popup.contains(event.target) &&            !translateIcon.contains(event.target)        ) {            popup.style.display = 'none';            translateIcon.style.display = 'none';        }    });})();